<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Actividad 8 - Panel de gr&aacute;ficas CONEVAL</title>
  <style>
    :root {
      --bg: #f6f8fb;
      --card: #ffffff;
      --text: #1b2735;
      --muted: #4c5b6b;
      --border: #d9e2ec;
      --error-bg: #fdecec;
      --error-text: #8f1d1d;
      --shadow: 0 10px 24px rgba(20, 40, 80, 0.08);
      --btn-bg: #f2f6fb;
      --btn-border: #c7d6e6;
      --btn-hover: #e4eef8;
      --btn-active: #1f6feb;
      --btn-active-text: #ffffff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, #eef3f9 0%, var(--bg) 100%);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 32px;
    }

    .page-header h1 {
      margin: 0 0 8px;
      font-size: clamp(1.5rem, 2vw, 2rem);
      line-height: 1.25;
    }

    .subtitle {
      margin: 0 0 12px;
      color: var(--muted);
      font-size: 0.96rem;
    }

    .source-note {
      margin: 0 0 10px;
      color: #314a66;
      font-size: 0.9rem;
      line-height: 1.35;
    }

    .author {
      margin: 0 0 16px;
      color: #2b3f56;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .controls-wrap {
      margin: 0 0 18px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #ffffff;
      box-shadow: var(--shadow);
    }

    .controls-title {
      margin: 0 0 10px;
      font-size: 0.92rem;
      color: #2b3f56;
      font-weight: 700;
    }

    .range-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .range-btn {
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: #14324f;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }

    .range-btn:hover {
      background: var(--btn-hover);
      border-color: #aac3dd;
    }

    .range-btn.is-active {
      background: var(--btn-active);
      border-color: var(--btn-active);
      color: var(--btn-active-text);
    }

    .error-banner {
      margin: 0 0 20px;
      padding: 12px 14px;
      background: var(--error-bg);
      color: var(--error-text);
      border: 1px solid #f5c2c2;
      border-radius: 10px;
      font-weight: 600;
    }

    .chart-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(280px, 1fr));
      gap: 16px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px;
      overflow: hidden;
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 1rem;
      line-height: 1.3;
      color: #152030;
    }

    .chart {
      width: 100%;
      height: 340px;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    @media (max-width: 900px) {
      .chart-grid {
        grid-template-columns: 1fr;
      }

      .full-width {
        grid-column: auto;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 14px 8px 20px;
      }

      .page-header h1 {
        font-size: 1.28rem;
      }

      .subtitle,
      .author,
      .source-note {
        font-size: 0.88rem;
      }

      .controls-wrap {
        padding: 10px;
      }

      .controls-title {
        font-size: 0.85rem;
        margin-bottom: 8px;
      }

      .range-controls {
        gap: 6px;
      }

      .range-btn {
        padding: 6px 10px;
        font-size: 0.8rem;
      }

      .chart-grid {
        gap: 10px;
      }

      .card {
        padding: 10px;
        border-radius: 10px;
      }

      .card h2 {
        font-size: 0.9rem;
      }

      .chart {
        height: 320px;
      }
    }
  </style>
</head>
<body>
  <main class="container">
    <header class="page-header">
      <h1>Actividad 8: Panel de gr&aacute;ficas con Google Charts</h1>
      <p class="source-note">Fuente: CONEVAL (2019). 10 a&ntilde;os de medici&oacute;n de pobreza en M&eacute;xico, avances y retos en pol&iacute;tica social (2008&ndash;2018).</p>
      <p class="subtitle">Datos base: CONEVAL, medici&oacute;n de pobreza en M&eacute;xico (serie 2008-2018).</p>
      <p class="author">Creado por Eduardo Arturo Garc&iacute;a Esquivel. Matr&iacute;cula: 940010328.</p>
    </header>

    <section class="controls-wrap" aria-label="Controles interactivos">
      <p class="controls-title">Selecciona un rango temporal:</p>
      <div id="range-controls" class="range-controls"></div>
    </section>

    <div id="error-banner" class="error-banner" role="alert" hidden></div>

    <section class="chart-grid">
      <article class="card">
        <h2>1) LineChart: evoluci&oacute;n de pobreza (%)</h2>
        <div id="chart-line" class="chart" aria-label="Gr&aacute;fica de l&iacute;nea sobre pobreza porcentual"></div>
      </article>

      <article class="card">
        <h2>2) ColumnChart: pobreza y pobreza extrema (%)</h2>
        <div id="chart-column" class="chart" aria-label="Gr&aacute;fica de columnas por a&ntilde;o"></div>
      </article>

      <article class="card">
        <h2>3) BarChart: comparaci&oacute;n por estado (sureste)</h2>
        <div id="chart-bar" class="chart" aria-label="Gr&aacute;fica de barras por estado"></div>
      </article>

      <article class="card">
        <h2>4) PieChart: composici&oacute;n del &uacute;ltimo a&ntilde;o del rango</h2>
        <div id="chart-pie" class="chart" aria-label="Gr&aacute;fica circular de composici&oacute;n"></div>
      </article>

      <article class="card full-width">
        <h2>5) AreaChart: pobreza y pobreza extrema (millones)</h2>
        <div id="chart-area" class="chart" aria-label="Gr&aacute;fica de &aacute;rea en millones"></div>
      </article>
    </section>
  </main>

  <script>
    "use strict";

    const CHART_DATA = {
      years: [2008, 2010, 2012, 2014, 2016, 2018],
      povertyPercent: [44.4, 46.1, 45.5, 46.2, 43.6, 41.9],
      extremePovertyPercent: [11.0, 11.3, 9.8, 9.5, 7.6, 7.4],
      povertyMillions: [49.5, 52.8, 53.3, 55.3, 53.4, 52.4],
      extremePovertyMillions: [12.3, 13.0, 11.5, 11.4, 9.4, 9.3],
      southeastStates: [
        { state: "Chiapas", series: [77.0, 78.5, 74.7, 76.2, 77.1, 76.4] },
        { state: "Guerrero", series: [68.4, 67.6, 69.7, 65.2, 64.4, 66.5] },
        { state: "Oaxaca", series: [61.8, 67.0, 61.9, 66.8, 70.4, 66.4] },
        { state: "Veracruz", series: [51.2, 57.6, 52.6, 58.0, 62.2, 61.8] }
      ]
    };

    const RANGE_PRESETS = {
      all: { label: "Todos (2008-2018)", start: 2008, end: 2018 },
      r2008_2014: { label: "2008-2014", start: 2008, end: 2014 },
      r2016_2018: { label: "2016-2018", start: 2016, end: 2018 }
    };

    let activeRangeKey = "all";
    let chartsLoaded = false;
    let resizeDebounceId = null;

    function isSmallMobile() {
      return window.innerWidth <= 480;
    }

    function showError(message) {
      const banner = document.getElementById("error-banner");
      if (!banner) {
        return;
      }
      banner.textContent = message;
      banner.hidden = false;
    }

    function hideError() {
      const banner = document.getElementById("error-banner");
      if (!banner) {
        return;
      }
      banner.hidden = true;
    }

    function getContainer(id) {
      const element = document.getElementById(id);
      if (!element) {
        showError("Error de estructura: falta el contenedor " + id + ".");
        return null;
      }
      return element;
    }

    function getYearIndexesForRange(rangeKey) {
      const preset = RANGE_PRESETS[rangeKey] || RANGE_PRESETS.all;
      const indexes = [];
      for (let i = 0; i < CHART_DATA.years.length; i += 1) {
        const year = CHART_DATA.years[i];
        if (year >= preset.start && year <= preset.end) {
          indexes.push(i);
        }
      }

      if (indexes.length < 2) {
        return CHART_DATA.years.map(function (_, idx) {
          return idx;
        });
      }

      return indexes;
    }

    function getFilteredSeries(rangeKey) {
      const indexes = getYearIndexesForRange(rangeKey);

      return {
        years: indexes.map(function (idx) { return CHART_DATA.years[idx]; }),
        povertyPercent: indexes.map(function (idx) { return CHART_DATA.povertyPercent[idx]; }),
        extremePovertyPercent: indexes.map(function (idx) { return CHART_DATA.extremePovertyPercent[idx]; }),
        povertyMillions: indexes.map(function (idx) { return CHART_DATA.povertyMillions[idx]; }),
        extremePovertyMillions: indexes.map(function (idx) { return CHART_DATA.extremePovertyMillions[idx]; }),
        southeastStates: CHART_DATA.southeastStates.map(function (item) {
          return {
            state: item.state,
            series: indexes.map(function (idx) { return item.series[idx]; })
          };
        })
      };
    }

    function getRangeStartEndIndexes(rangeKey) {
      const indexes = getYearIndexesForRange(rangeKey);
      return {
        startIdx: indexes[0],
        endIdx: indexes[indexes.length - 1]
      };
    }

    function hasGoogleLoader() {
      return typeof window.google !== "undefined" && !!google.charts;
    }

    function hasGoogleVisualization() {
      return hasGoogleLoader() && !!google.visualization;
    }

    function renderRangeButtons() {
      const container = getContainer("range-controls");
      if (!container) {
        return;
      }

      container.innerHTML = "";
      Object.keys(RANGE_PRESETS).forEach(function (key) {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "range-btn" + (key === activeRangeKey ? " is-active" : "");
        button.textContent = RANGE_PRESETS[key].label;
        button.setAttribute("aria-pressed", key === activeRangeKey ? "true" : "false");
        button.addEventListener("click", function () {
          setActiveRange(key);
        });
        container.appendChild(button);
      });
    }

    function setActiveRange(rangeKey) {
      if (!RANGE_PRESETS[rangeKey]) {
        showError("Rango temporal no valido: " + rangeKey + ". Se usa el rango completo.");
        activeRangeKey = "all";
      } else {
        hideError();
        activeRangeKey = rangeKey;
      }

      renderRangeButtons();
      drawAllCharts();
    }

    function initGoogleCharts() {
      if (!hasGoogleLoader()) {
        showError("No se pudo inicializar Google Charts.");
        return;
      }

      google.charts.load("current", { packages: ["corechart"] });
      google.charts.setOnLoadCallback(function () {
        chartsLoaded = true;
        hideError();
        renderRangeButtons();
        drawAllCharts();
        installResizeHandler();
      });

      window.setTimeout(function () {
        if (!chartsLoaded) {
          showError("Google Charts no respondio a tiempo. Revisa tu conexion a Internet.");
        }
      }, 8000);
    }

    function installResizeHandler() {
      if (installResizeHandler.installed) {
        return;
      }
      installResizeHandler.installed = true;

      window.addEventListener("resize", function () {
        if (!chartsLoaded) {
          return;
        }
        window.clearTimeout(resizeDebounceId);
        resizeDebounceId = window.setTimeout(function () {
          drawAllCharts();
        }, 200);
      });
    }

    function drawAllCharts() {
      if (!hasGoogleVisualization()) {
        showError("La visualizacion no esta lista para dibujar las graficas.");
        return;
      }

      const filtered = getFilteredSeries(activeRangeKey);
      const rangePoints = getRangeStartEndIndexes(activeRangeKey);

      drawLineChart(filtered);
      drawColumnChart(filtered);
      drawBarChart(rangePoints);
      drawPieChart(filtered);
      drawAreaChart(filtered);
    }

    function drawLineChart(filtered) {
      const container = getContainer("chart-line");
      if (!container) {
        return;
      }
      const mobile = isSmallMobile();

      const rows = filtered.years.map(function (year, idx) {
        return [String(year), filtered.povertyPercent[idx]];
      });

      const data = google.visualization.arrayToDataTable([
        ["A\u00f1o", "Pobreza"],
        ...rows
      ]);

      const options = {
        title: "Evolucion nacional de pobreza (%)",
        legend: mobile ? { position: "none" } : { position: "bottom" },
        hAxis: { title: mobile ? "" : "A\u00f1o", slantedText: false, textStyle: { fontSize: mobile ? 10 : 12 } },
        vAxis: { title: "Porcentaje", minValue: 0, maxValue: 100 },
        colors: ["#1f77b4"],
        fontSize: mobile ? 11 : 12,
        chartArea: mobile
          ? { left: 42, top: 48, width: "84%", height: "68%" }
          : { left: 60, top: 50, width: "78%", height: "70%" }
      };

      new google.visualization.LineChart(container).draw(data, options);
    }

    function drawColumnChart(filtered) {
      const container = getContainer("chart-column");
      if (!container) {
        return;
      }
      const mobile = isSmallMobile();

      const rows = filtered.years.map(function (year, idx) {
        return [String(year), filtered.povertyPercent[idx], filtered.extremePovertyPercent[idx]];
      });

      const data = google.visualization.arrayToDataTable([
        ["A\u00f1o", "Pobreza", "Extrema"],
        ...rows
      ]);

      const options = {
        title: "Comparacion por a\u00f1o (%)",
        legend: mobile
          ? { position: "top", maxLines: 2, textStyle: { fontSize: 10 } }
          : { position: "bottom" },
        hAxis: { textStyle: { fontSize: mobile ? 10 : 12 } },
        vAxis: { title: "Porcentaje", minValue: 0, maxValue: 100 },
        colors: ["#2e86de", "#e67e22"],
        fontSize: mobile ? 11 : 12,
        chartArea: mobile
          ? { left: 42, top: 78, width: "84%", height: "56%" }
          : { left: 60, top: 50, width: "78%", height: "70%" }
      };

      new google.visualization.ColumnChart(container).draw(data, options);
    }

    function drawBarChart(rangePoints) {
      const container = getContainer("chart-bar");
      if (!container) {
        return;
      }
      const mobile = isSmallMobile();

      const startYear = CHART_DATA.years[rangePoints.startIdx];
      const endYear = CHART_DATA.years[rangePoints.endIdx];
      const rows = CHART_DATA.southeastStates.map(function (item) {
        return [item.state, item.series[rangePoints.startIdx], item.series[rangePoints.endIdx]];
      });

      const data = google.visualization.arrayToDataTable([
        ["Estado", String(startYear), String(endYear)],
        ...rows
      ]);

      const options = {
        title: "Pobreza por estado del sureste (" + startYear + " vs " + endYear + ")",
        legend: mobile
          ? { position: "top", maxLines: 2, textStyle: { fontSize: 10 } }
          : { position: "bottom" },
        hAxis: { title: mobile ? "" : "Porcentaje", minValue: 0, maxValue: 100 },
        colors: ["#16a085", "#8e44ad"],
        fontSize: mobile ? 11 : 12,
        chartArea: mobile
          ? { left: 84, top: 78, width: "60%", height: "56%" }
          : { left: 90, top: 50, width: "72%", height: "70%" }
      };

      new google.visualization.BarChart(container).draw(data, options);
    }

    function drawPieChart(filtered) {
      const container = getContainer("chart-pie");
      if (!container) {
        return;
      }
      const mobile = isSmallMobile();

      const lastIndex = filtered.years.length - 1;
      const targetYear = filtered.years[lastIndex];
      const poverty = filtered.povertyPercent[lastIndex];
      const nonPoverty = Number((100 - poverty).toFixed(1));

      const data = google.visualization.arrayToDataTable([
        ["Categoria", "Porcentaje"],
        ["Pobreza", poverty],
        ["Resto de la poblaci\u00f3n (no en pobreza)", nonPoverty]
      ]);

      const options = {
        title: "Distribuci\u00f3n de la poblaci\u00f3n seg\u00fan condici\u00f3n de pobreza",
        pieHole: 0.25,
        legend: mobile
          ? { position: "top", maxLines: 2, textStyle: { fontSize: 10 } }
          : { position: "bottom" },
        colors: ["#d63031", "#00b894"],
        fontSize: mobile ? 11 : 12,
        chartArea: mobile
          ? { left: 10, top: 78, width: "88%", height: "56%" }
          : { left: 20, top: 50, width: "90%", height: "70%" }
      };

      new google.visualization.PieChart(container).draw(data, options);
    }

    function drawAreaChart(filtered) {
      const container = getContainer("chart-area");
      if (!container) {
        return;
      }
      const mobile = isSmallMobile();

      const rows = filtered.years.map(function (year, idx) {
        return [String(year), filtered.povertyMillions[idx], filtered.extremePovertyMillions[idx]];
      });

      const data = google.visualization.arrayToDataTable([
        ["A\u00f1o", "Pobreza", "Extrema"],
        ...rows
      ]);

      const options = {
        title: "Comparacion en millones de personas",
        legend: mobile
          ? { position: "top", maxLines: 2, textStyle: { fontSize: 10 } }
          : { position: "bottom" },
        hAxis: { title: mobile ? "" : "A\u00f1o", textStyle: { fontSize: mobile ? 10 : 12 } },
        vAxis: { title: "Millones de personas", minValue: 0 },
        colors: ["#0984e3", "#fdcb6e"],
        isStacked: false,
        areaOpacity: 0.25,
        fontSize: mobile ? 11 : 12,
        chartArea: mobile
          ? { left: 50, top: 78, width: "76%", height: "56%" }
          : { left: 70, top: 50, width: "80%", height: "70%" }
      };

      new google.visualization.AreaChart(container).draw(data, options);
    }

    window.onGoogleChartsLoadError = function () {
      showError("No se pudo cargar la libreria de Google Charts. Revisa conexion o firewall.");
    };
  </script>

  <script src="https://www.gstatic.com/charts/loader.js" onload="initGoogleCharts()" onerror="onGoogleChartsLoadError()"></script>
</body>
</html>
